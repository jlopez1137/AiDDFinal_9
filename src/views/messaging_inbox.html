{% extends 'layouts/base.html' %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Messages</h1>
      <p class="text-muted mb-0">Stay in touch with resource owners and administrators.</p>
    </div>
    {% if current_user.is_admin %}
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.threads') }}">Admin inbox</a>
    {% endif %}
  </div>

  <div class="card shadow-sm">
    <div class="list-group list-group-flush">
      {% for item in threads %}
        <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start gap-3" href="{{ url_for('messaging.thread', thread_id=item.thread.thread_id) }}">
          <div>
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="badge bg-secondary-subtle text-secondary text-uppercase">{{ item.thread.context_type }}</span>
              {% if item.context.resource %}
                <span class="fw-semibold">{{ item.context.resource.title }}</span>
              {% elif item.thread.context_type == 'general' %}
                <span class="fw-semibold">General</span>
              {% endif %}
              {% if item.has_unread %}
                <span class="badge bg-danger">New</span>
              {% endif %}
            </div>
            <p class="text-muted small mb-1">
              {% if item.last_message %}
                Updated {{ item.last_message.timestamp.strftime('%b %d, %Y %I:%M %p') }}
              {% else %}
                No messages yet
              {% endif %}
            </p>
            <p class="mb-0 text-truncate">
              {% if item.last_message %}
                {{ item.last_message.content }}
              {% else %}
                <span class="text-muted small">Start the conversation.</span>
              {% endif %}
            </p>
          </div>
          <span class="badge bg-primary-subtle text-primary">{{ item.message_count }} messages</span>
        </a>
      {% else %}
        <div class="list-group-item text-center text-muted py-4">
          You have no message threads yet.
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}


